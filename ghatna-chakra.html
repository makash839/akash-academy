<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTA Mock Test - National Testing Agency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        .hidden-all { display: none !important; }

        .nta-blue { background-color: #003366; }
        .nta-orange { background-color: #FF9933; }
        .nta-green { background-color: #28a745; }
        .nta-purple { background-color: #6f42c1; }
        .nta-red { background-color: #dc3545; }

        .password-container {
            background: linear-gradient(135deg, #003366 0%, #004080 50%, #0059b3 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .password-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        .password-header {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .password-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FF9933 0%, #FF9933 33%, #fff 33%, #fff 66%, #138808 66%, #138808 100%);
        }
        .nta-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .nta-logo-inner {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #FF9933 0deg 120deg, #fff 120deg 240deg, #138808 240deg 360deg);
        }
        .password-input {
            width: 100%;
            padding: 15px 15px 15px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .password-input:focus {
            border-color: #003366;
            outline: none;
            box-shadow: 0 0 0 4px rgba(0,51,102,0.1);
        }
        .unlock-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .palette-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            background: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .palette-btn:hover { transform: scale(1.1); }
        .palette-not-visited { background: #f8f9fa; border-color: #adb5bd; color: #6c757d; }
        .palette-not-answered { background: #dc3545; border-color: #dc3545; color: white; }
        .palette-answered { background: #28a745; border-color: #28a745; color: white; }
        .palette-marked { background: #6f42c1; border-color: #6f42c1; color: white; }
        .palette-answered-marked { 
            background: #6f42c1; 
            border-color: #28a745; 
            color: white;
            position: relative;
        }
        .palette-answered-marked::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
        }
        .palette-current { 
            box-shadow: 0 0 0 3px #FF9933;
            transform: scale(1.15);
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-label:hover { background: #f8f9fa; border-color: #adb5bd; }
        .option-label.selected { 
            background: #e3f2fd; 
            border-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33,150,243,0.2);
        }
        .option-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f8f9fa;
            border: 2px solid #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
        }
        .option-label.selected .option-circle {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
        }

        .timer-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .btn-nta {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-save-next { background: #28a745; color: white; }
        .btn-save-review { background: #ffc107; color: #212529; }
        .btn-clear { background: #6c757d; color: white; }
        .btn-mark-review { background: #6f42c1; color: white; }
        .btn-submit { background: #dc3545; color: white; }
        .btn-proceed { background: #003366; color: white; padding: 12px 40px; font-size: 1.1rem; }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .question-image {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px auto;
            display: block;
        }

        /* LIST MATCHING STYLES - ENHANCED */
        .list-matching-wrapper {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #003366;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .list-matching-title {
            text-align: center;
            color: #003366;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }
        .list-matching-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .list-matching-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        .list-box {
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
        }
        .list-box-header {
            background: #003366;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        .list-box-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f1f5f9;
            border-radius: 6px;
            border-left: 4px solid #FF9933;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .list-box-item:last-child {
            margin-bottom: 0;
        }
        .list-key {
            font-weight: bold;
            color: #003366;
            margin-right: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- PASSWORD OVERLAY -->
    <div id="passwordOverlay" class="password-container">
        <div class="password-card">
            <div class="password-header">
                <div class="nta-logo"><div class="nta-logo-inner"></div></div>
                <h1 class="text-white text-xl font-bold">NATIONAL TESTING AGENCY</h1>
                <p class="text-blue-200 text-sm mt-1">Excellence in Assessment</p>
            </div>
            <div class="p-8">
                <h2 class="text-center text-gray-800 text-lg font-semibold mb-2">Secure Login</h2>
                <p class="text-center text-gray-500 text-sm mb-6">Please enter your password to access the mock test</p>
                <div class="relative mb-4">
                    <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                    <input type="password" id="sitePass" class="password-input" placeholder="Enter Password">
                </div>
                <button onclick="checkPass()" class="unlock-btn"><i class="fas fa-unlock-alt mr-2"></i>Access Test</button>
                <div id="passError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded text-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Incorrect password. Please try again.
                </div>
            </div>
        </div>
    </div>

    <!-- LOADING SECTION -->
    <div id="loadingSection" class="hidden-all min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold text-gray-700">Loading Questions...</p>
        </div>
    </div>

    <!-- SUBJECT SELECTION -->
    <div id="subjectSection" class="hidden-all min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="nta-orange text-white p-4 rounded-t-lg -mx-6 -mt-6 mb-6 text-center">
                <h2 class="text-xl font-bold"><i class="fas fa-book mr-2"></i>Select Subject</h2>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Subject</label>
                    <select id="mainSubject" onchange="updateSubSubjects()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="">-- Select Subject --</option>
                    </select>
                </div>
                <div id="subSubjectContainer" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2">Sub-Subject / Topic</label>
                    <select id="subSubject" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="">-- All Topics --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Number of Questions</label>
                    <select id="questionCount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none">
                        <option value="10">10 Questions</option>
                        <option value="25">25 Questions</option>
                        <option value="50">50 Questions</option>
                        <option value="100">100 Questions</option>
                        <option value="all">All Available</option>
                    </select>
                </div>
                <button onclick="startExam()" class="w-full btn-nta btn-proceed mt-4"><i class="fas fa-play mr-2"></i>Start Exam</button>
            </div>
        </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div id="instructionSection" class="hidden-all">
        <div class="nta-blue text-white p-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-green-500"></div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">NATIONAL TESTING AGENCY</h1>
                        <p class="text-xs text-blue-200">Excellence in Assessment</p>
                    </div>
                </div>
                <select id="languageSelect" onchange="changeLanguage()" class="p-2 rounded text-gray-800 text-sm border-2 border-gray-300">
                    <option value="hi">हिंदी</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
        <div class="nta-orange text-white p-3">
            <div class="max-w-7xl mx-auto"><h2 class="text-lg font-bold">GENERAL INSTRUCTIONS</h2></div>
        </div>
        <div class="max-w-5xl mx-auto p-6">
            <h3 class="text-xl font-bold text-center mb-6">Please read the instructions carefully</h3>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <ol class="list-decimal list-inside space-y-3 text-gray-700">
                    <li>Total duration of the test will be displayed on the timer.</li>
                    <li>The clock will be set at the server.</li>
                    <li>When the timer reaches zero, the examination will end by itself.</li>
                </ol>
                <div class="mt-6 grid md:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-gray-400"></div>
                        <span>You have <strong>not visited</strong> the question yet.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-red-500"></div>
                        <span>You have <strong>not answered</strong> the question.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-green-500"></div>
                        <span>You have <strong>answered</strong> the question.</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-purple-600"></div>
                        <span>You have <strong>marked for review</strong>.</span>
                    </div>
                </div>
                <div class="mt-6">
                    <p class="font-bold">Marking Scheme:</p>
                    <ul class="list-disc list-inside mt-2">
                        <li><span class="text-green-600 font-bold">+1 Mark</span> for correct answer</li>
                        <li><span class="text-red-600 font-bold">-0.25 Mark</span> for wrong answer</li>
                        <li><span class="text-gray-600 font-bold">0 Mark</span> for unattempted</li>
                    </ul>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="declaration" class="mt-1 w-5 h-5">
                    <span class="text-gray-700">I have read and understood the instructions.</span>
                </label>
            </div>
            <div class="text-center">
                <button onclick="proceedToExam()" class="btn-nta btn-proceed"><i class="fas fa-arrow-right mr-2"></i>PROCEED</button>
            </div>
        </div>
    </div>

    <!-- EXAM SECTION -->
    <div id="examSection" class="hidden-all">
        <div class="nta-blue text-white p-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-green-500"></div>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold">NATIONAL TESTING AGENCY</h1>
                        <p class="text-xs text-blue-200">Excellence in Assessment</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-blue-200">Subject</p>
                        <p class="font-semibold" id="examSubject">Test</p>
                    </div>
                    <div class="timer-box">
                        <i class="fas fa-clock mr-2"></i><span id="timer">00:00:00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-4">
            <div class="flex flex-col lg:flex-row gap-4">
                <!-- Question Area -->
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">Question <span id="qNumber">1</span>:</h3>
                    <div id="questionText" class="text-gray-800 mb-6 text-lg leading-relaxed"></div>
                    <div id="listMatchingContainer"></div>
                    <div id="optionsContainer" class="space-y-3"></div>

                    <div class="mt-8 flex flex-wrap gap-3">
                        <button onclick="saveAndNext()" class="btn-nta btn-save-next"><i class="fas fa-save mr-1"></i>Save & Next</button>
                        <button onclick="saveAndMarkReview()" class="btn-nta btn-save-review"><i class="fas fa-bookmark mr-1"></i>Save & Mark for Review</button>
                        <button onclick="clearResponse()" class="btn-nta btn-clear"><i class="fas fa-eraser mr-1"></i>Clear Response</button>
                        <button onclick="markReviewAndNext()" class="btn-nta btn-mark-review"><i class="fas fa-flag mr-1"></i>Mark for Review & Next</button>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <button onclick="prevQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100"><i class="fas fa-chevron-left mr-1"></i>Back</button>
                        <button onclick="nextQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100">Next<i class="fas fa-chevron-right ml-1"></i></button>
                    </div>
                </div>

                <!-- Palette -->
                <div class="lg:w-80 bg-white rounded-lg shadow p-4">
                    <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Question Palette</h4>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-gray-400 flex items-center justify-center text-white font-bold" id="statNotVisited">0</span><span>Not Visited</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-red-500 flex items-center justify-center text-white font-bold" id="statNotAnswered">0</span><span>Not Answered</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-green-500 flex items-center justify-center text-white font-bold" id="statAnswered">0</span><span>Answered</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-purple-600 flex items-center justify-center text-white font-bold" id="statMarked">0</span><span>Marked</span></div>
                    </div>
                    <div id="questionPalette" class="grid grid-cols-5 gap-2 max-h-80 overflow-y-auto p-2"></div>
                    <button onclick="confirmSubmit()" class="w-full mt-4 btn-nta btn-submit py-3"><i class="fas fa-check-circle mr-2"></i>SUBMIT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBMIT MODAL -->
    <div id="submitModal" class="hidden-all fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-center mb-4">Exam Summary</h3>
            <table class="w-full mb-6 text-sm">
                <tbody id="summaryTable"></tbody>
            </table>
            <p class="text-center text-gray-700 mb-4 font-semibold">Are you sure you want to submit?</p>
            <div class="flex justify-center gap-4">
                <button onclick="finalSubmit()" class="px-6 py-2 bg-green-500 text-white rounded font-semibold">YES</button>
                <button onclick="closeSubmitModal()" class="px-6 py-2 bg-gray-500 text-white rounded font-semibold">NO</button>
            </div>
        </div>
    </div>

    <!-- RESULT SECTION -->
    <div id="resultSection" class="hidden-all">
        <div class="nta-blue text-white p-4 text-center">
            <h1 class="text-2xl font-bold">NATIONAL TESTING AGENCY</h1>
            <p class="text-blue-200">Excellence in Assessment</p>
        </div>
        <div class="max-w-5xl mx-auto p-6">
            <h2 class="text-2xl font-bold text-center mb-6">Result</h2>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Total</p>
                        <p class="text-2xl font-bold text-blue-600" id="resTotal">0</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Correct</p>
                        <p class="text-2xl font-bold text-green-600" id="resCorrect">0</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Wrong</p>
                        <p class="text-2xl font-bold text-red-600" id="resWrong">0</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <p class="text-gray-600 text-sm">Unattempted</p>
                        <p class="text-2xl font-bold text-yellow-600" id="resUnattempted">0</p>
                    </div>
                </div>
                <div class="text-center p-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg text-white">
                    <p class="text-lg mb-2">Final Score</p>
                    <p class="text-5xl font-bold" id="resScore">0.00</p>
                    <p class="text-sm mt-2 opacity-80">(+1 for correct, -0.25 for wrong)</p>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="restartTest()" class="btn-nta btn-proceed mr-3"><i class="fas fa-redo mr-2"></i>Take Again</button>
                    <button onclick="newTest()" class="btn-nta bg-gray-600 text-white px-6 py-3 rounded"><i class="fas fa-home mr-2"></i>New Test</button>
                </div>
            </div>

            <h3 class="text-xl font-bold mb-4 text-red-600"><i class="fas fa-times-circle mr-2"></i>Wrong Answers</h3>
            <div id="wrongQuestionsList" class="space-y-4 mb-8"></div>

            <h3 class="text-xl font-bold mb-4 text-green-600"><i class="fas fa-check-circle mr-2"></i>Correct Answers</h3>
            <div id="correctQuestionsList" class="space-y-4 mb-8"></div>

            <h3 class="text-xl font-bold mb-4 text-gray-600"><i class="fas fa-minus-circle mr-2"></i>Unattempted</h3>
            <div id="skippedQuestionsList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            PASSWORD: '208019',
            SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-DLQLn-selNmHf2J8_Qp8cdOz8_YF0VUAMt1QxxePnK09bCAPDJvJznZndAuxuGr5E4UCQHZwhOkl/pub?output=csv'
        };

        // ==================== GLOBALS ====================
        let allQuestions = [];
        let currentQuestions = [];
        let userAnswers = [];
        let questionStatus = [];
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = 0;
        let selectedOption = null;
        let hasEnglishColumns = false;
        let hasListColumns = false;

        // ==================== PASSWORD ====================
        function checkPass() {
            if (document.getElementById('sitePass').value === CONFIG.PASSWORD) {
                document.getElementById('passwordOverlay').classList.add('hidden-all');
                document.getElementById('loadingSection').classList.remove('hidden-all');
                loadData();
            } else {
                document.getElementById('passError').classList.remove('hidden');
            }
        }

        document.getElementById('sitePass')?.addEventListener('keypress', e => { if (e.key === 'Enter') checkPass(); });

        // ==================== LOAD DATA ====================
        function loadData() {
            Papa.parse(CONFIG.SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allQuestions = results.data.filter(q => q.Question && q.Question.trim() !== '');
                        
                        if (allQuestions.length > 0) {
                            const keys = Object.keys(allQuestions[0]);
                            // Check if List columns exist (just check column names, not data)
                            hasListColumns = keys.includes('List1_A') && keys.includes('List2_1');
                            hasEnglishColumns = keys.includes('English_Question') || keys.includes('English Question');
                            
                            console.log('Sheet columns found:', keys);
                            console.log('Has List Columns:', hasListColumns);
                        }
                        
                        populateSubjects();
                        document.getElementById('loadingSection').classList.add('hidden-all');
                        document.getElementById('subjectSection').classList.remove('hidden-all');
                    }
                },
                error: function(err) {
                    alert('Error loading data: ' + err.message);
                }
            });
        }

        function populateSubjects() {
            const subjects = [...new Set(allQuestions.map(q => q.Subject))].filter(s => s).sort();
            const select = document.getElementById('mainSubject');
            select.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => select.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function updateSubSubjects() {
            const subject = document.getElementById('mainSubject').value;
            const container = document.getElementById('subSubjectContainer');
            const subSelect = document.getElementById('subSubject');

            if (!subject) { container.classList.add('hidden'); return; }

            const subSubjects = [...new Set(allQuestions
                .filter(q => q.Subject === subject)
                .map(q => q['Sub-Subject'] || q.SubSubject || q.Topic)
                .filter(s => s))].sort();

            if (subSubjects.length > 0) {
                container.classList.remove('hidden');
                subSelect.innerHTML = '<option value="">-- All Topics --</option>';
                subSubjects.forEach(s => subSelect.innerHTML += `<option value="${s}">${s}</option>`);
            } else {
                container.classList.add('hidden');
            }
        }

        // ==================== QUESTION TYPE DETECTION ====================
        function getQuestionType(q) {
            if (!hasListColumns) return 'regular';
            
            const questionText = (q.Question || '').toLowerCase();
            
            // Check for matching keywords
            const hasMatchingKeywords = 
                questionText.includes('मिलान') || 
                questionText.includes('सुमेलित') ||
                questionText.includes('सूची') ||
                questionText.includes('match') ||
                questionText.includes('matching');
            
            // Check if THIS specific question has list data
            const hasListData = (q.List1_A && q.List1_A.trim() !== '') || 
                               (q.List1_B && q.List1_B.trim() !== '');
            
            return (hasMatchingKeywords && hasListData) ? 'list-matching' : 'regular';
        }

        // ==================== GET LIST DATA ====================
        function getListData(q) {
            const list1 = [];
            const list2 = [];
            
            // List 1: A, B, C, D
            if (q.List1_A && q.List1_A.trim() !== '') list1.push({ key: 'A', text: q.List1_A.trim() });
            if (q.List1_B && q.List1_B.trim() !== '') list1.push({ key: 'B', text: q.List1_B.trim() });
            if (q.List1_C && q.List1_C.trim() !== '') list1.push({ key: 'C', text: q.List1_C.trim() });
            if (q.List1_D && q.List1_D.trim() !== '') list1.push({ key: 'D', text: q.List1_D.trim() });
            
            // List 2: 1, 2, 3, 4
            if (q.List2_1 && q.List2_1.trim() !== '') list2.push({ key: '1', text: q.List2_1.trim() });
            if (q.List2_2 && q.List2_2.trim() !== '') list2.push({ key: '2', text: q.List2_2.trim() });
            if (q.List2_3 && q.List2_3.trim() !== '') list2.push({ key: '3', text: q.List2_3.trim() });
            if (q.List2_4 && q.List2_4.trim() !== '') list2.push({ key: '4', text: q.List2_4.trim() });
            
            return { list1, list2 };
        }

        // ==================== GET OPTIONS ====================
        function getAvailableOptions(q, lang) {
            const useEnglish = lang === 'en' && hasEnglishColumns;
            const options = [];
            const optionKeys = ['A', 'B', 'C', 'D', 'E'];
            
            optionKeys.forEach(key => {
                let optionText = null;
                if (useEnglish) {
                    optionText = q[`English_Option_${key}`] || q[`English Option ${key}`] || q[`Option ${key}`] || q[`Option${key}`] || q[key];
                } else {
                    optionText = q[`Option ${key}`] || q[`Option${key}`] || q[key];
                }
                
                if (optionText && optionText.toString().trim() !== '') {
                    options.push({ key: key, text: optionText.toString().trim(), index: options.length + 1 });
                }
            });
            return options;
        }

        // ==================== GET CORRECT ANSWER ====================
        function getCorrectAnswerIndex(q, availableOptions) {
            const correctAns = (q.Answer || '').toString().trim();
            const cleanAns = correctAns.replace(/[()]/g, '').toUpperCase();
            const correctOption = availableOptions.find(opt => opt.key === cleanAns || opt.index.toString() === cleanAns);
            return correctOption ? correctOption.index.toString() : cleanAns;
        }

        // ==================== START EXAM ====================
        function startExam() {
            const subject = document.getElementById('mainSubject').value;
            const subSubject = document.getElementById('subSubject').value;
            const count = document.getElementById('questionCount').value;

            if (!subject) { alert('Please select a subject!'); return; }

            currentQuestions = allQuestions.filter(q => {
                if (q.Subject !== subject) return false;
                if (subSubject) {
                    const qSub = q['Sub-Subject'] || q.SubSubject || q.Topic;
                    if (qSub !== subSubject) return false;
                }
                return true;
            });

            if (currentQuestions.length === 0) { alert('No questions found!'); return; }
            if (count !== 'all' && currentQuestions.length > parseInt(count)) {
                currentQuestions = currentQuestions.slice(0, parseInt(count));
            }

            userAnswers = new Array(currentQuestions.length).fill(null);
            questionStatus = new Array(currentQuestions.length).fill('not-visited');
            currentIndex = 0;

            document.getElementById('examSubject').textContent = subject;
            document.getElementById('subjectSection').classList.add('hidden-all');
            document.getElementById('instructionSection').classList.remove('hidden-all');
        }

        function changeLanguage() {
            const lang = document.getElementById('languageSelect').value;
            if (lang === 'en' && !hasEnglishColumns) {
                alert('English questions not available. Using Hindi.');
                document.getElementById('languageSelect').value = 'hi';
            }
        }

        function proceedToExam() {
            if (!document.getElementById('declaration').checked) {
                alert('Please accept the declaration!');
                return;
            }
            document.getElementById('instructionSection').classList.add('hidden-all');
            document.getElementById('examSection').classList.remove('hidden-all');
            timeRemaining = currentQuestions.length * 60;
            startTimer();
            renderQuestion();
            renderPalette();
            updateStats();
        }

        // ==================== TIMER ====================
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finalSubmit();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const h = Math.floor(timeRemaining / 3600);
            const m = Math.floor((timeRemaining % 3600) / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        // ==================== RENDER QUESTION ====================
        function renderQuestion() {
            const q = currentQuestions[currentIndex];
            const lang = document.getElementById('languageSelect').value;
            const qType = getQuestionType(q);
            
            document.getElementById('qNumber').textContent = currentIndex + 1;
            if (questionStatus[currentIndex] === 'not-visited') {
                questionStatus[currentIndex] = 'not-answered';
            }

            let questionText = q.Question || '';
            const images = [];
            const imageRegex = /\[IMAGE:(.*?)\]/g;
            let match;
            
            while ((match = imageRegex.exec(questionText)) !== null) {
                images.push(match[1]);
            }
            questionText = questionText.replace(/\[IMAGE:.*?\]/g, '').trim();

            let fullHtml = `<div class="mb-4">${questionText}</div>`;
            
            if (images.length > 0) {
                images.forEach((imgUrl, idx) => {
                    fullHtml += `
                        <div class="my-4 text-center">
                            <img src="${imgUrl}" alt="Question Image ${idx + 1}" class="question-image"
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'image-error\'>Image not loaded</div>';">
                        </div>`;
                });
            }

            document.getElementById('questionText').innerHTML = fullHtml;

            // Handle List Matching Display
            const listContainer = document.getElementById('listMatchingContainer');
            listContainer.innerHTML = '';
            
            if (qType === 'list-matching') {
                const { list1, list2 } = getListData(q);
                
                if (list1.length > 0 || list2.length > 0) {
                    let listHtml = '<div class="list-matching-wrapper">';
                    listHtml += '<div class="list-matching-title">सूचियों का मिलान करें</div>';
                    listHtml += '<div class="list-matching-grid">';
                    
                    listHtml += '<div class="list-box">';
                    listHtml += '<div class="list-box-header">सूची - I</div>';
                    if (list1.length > 0) {
                        list1.forEach(item => {
                            listHtml += `<div class="list-box-item"><span class="list-key">${item.key}.</span>${item.text}</div>`;
                        });
                    } else {
                        listHtml += '<div class="list-box-item" style="color:#999">No data</div>';
                    }
                    listHtml += '</div>';
                    
                    listHtml += '<div class="list-box">';
                    listHtml += '<div class="list-box-header">सूची - II</div>';
                    if (list2.length > 0) {
                        list2.forEach(item => {
                            listHtml += `<div class="list-box-item"><span class="list-key">${item.key}.</span>${item.text}</div>`;
                        });
                    } else {
                        listHtml += '<div class="list-box-item" style="color:#999">No data</div>';
                    }
                    listHtml += '</div>';
                    
                    listHtml += '</div></div>';
                    listContainer.innerHTML = listHtml;
                }
            }

            // Render options
            const optionsDiv = document.getElementById('optionsContainer');
            optionsDiv.innerHTML = '';
            const availableOptions = getAvailableOptions(q, lang);

            if (availableOptions.length === 0) {
                optionsDiv.innerHTML = '<div class="text-red-500">No options found!</div>';
                return;
            }

            availableOptions.forEach((opt) => {
                const label = document.createElement('label');
                label.className = 'option-label';
                const userAnswerNum = userAnswers[currentIndex];
                const isSelected = userAnswerNum && parseInt(userAnswerNum) === opt.index;
                if (isSelected) label.classList.add('selected');
                label.onclick = () => selectOption(opt.index.toString(), availableOptions.length);

                label.innerHTML = `
                    <div class="option-circle">${opt.key}</div>
                    <div class="flex-1">${opt.text}</div>
                    <input type="radio" name="option" value="${opt.index}" class="hidden" ${isSelected ? 'checked' : ''}>
                `;
                optionsDiv.appendChild(label);
            });

            selectedOption = userAnswers[currentIndex];
            renderPalette();
            updateStats();
        }

        function selectOption(value, totalOptions) {
            selectedOption = value;
            userAnswers[currentIndex] = value;
            questionStatus[currentIndex] = 'answered';
            renderQuestion();
        }

        function renderPalette() {
            const palette = document.getElementById('questionPalette');
            palette.innerHTML = '';

            for (let i = 0; i < currentQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.textContent = i + 1;
                let statusClass = 'palette-not-visited';
                if (questionStatus[i] === 'not-answered') statusClass = 'palette-not-answered';
                else if (questionStatus[i] === 'answered') statusClass = 'palette-answered';
                else if (questionStatus[i] === 'marked') statusClass = 'palette-marked';
                else if (questionStatus[i] === 'answered-marked') statusClass = 'palette-answered-marked';
                btn.classList.add(statusClass);
                if (i === currentIndex) btn.classList.add('palette-current');
                btn.onclick = () => { currentIndex = i; renderQuestion(); };
                palette.appendChild(btn);
            }
        }

        function updateStats() {
            document.getElementById('statNotVisited').textContent = questionStatus.filter(s => s === 'not-visited').length;
            document.getElementById('statNotAnswered').textContent = questionStatus.filter(s => s === 'not-answered').length;
            document.getElementById('statAnswered').textContent = questionStatus.filter(s => s === 'answered' || s === 'answered-marked').length;
            document.getElementById('statMarked').textContent = questionStatus.filter(s => s === 'marked' || s === 'answered-marked').length;
        }

        // ==================== NAVIGATION ====================
        function saveAndNext() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function saveAndMarkReview() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered-marked';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function clearResponse() {
            selectedOption = null;
            userAnswers[currentIndex] = null;
            questionStatus[currentIndex] = 'not-answered';
            renderQuestion();
        }

        function markReviewAndNext() {
            if (selectedOption) {
                userAnswers[currentIndex] = selectedOption;
                questionStatus[currentIndex] = 'answered-marked';
            } else {
                questionStatus[currentIndex] = 'marked';
            }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function nextQuestion() {
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function prevQuestion() {
            if (currentIndex > 0) { currentIndex--; renderQuestion(); }
        }

        // ==================== SUBMIT ====================
        function confirmSubmit() {
            const stats = {
                answered: questionStatus.filter(s => s === 'answered' || s === 'answered-marked').length,
                notAnswered: questionStatus.filter(s => s === 'not-answered').length,
                marked: questionStatus.filter(s => s === 'marked' || s === 'answered-marked').length,
                notVisited: questionStatus.filter(s => s === 'not-visited').length
            };

            document.getElementById('summaryTable').innerHTML = `
                <tr class="border-b"><td class="p-2">Answered</td><td class="p-2 text-center font-bold">${stats.answered}</td></tr>
                <tr class="border-b"><td class="p-2">Not Answered</td><td class="p-2 text-center font-bold">${stats.notAnswered}</td></tr>
                <tr class="border-b"><td class="p-2">Marked for Review</td><td class="p-2 text-center font-bold">${stats.marked}</td></tr>
                <tr class="border-b"><td class="p-2">Not Visited</td><td class="p-2 text-center font-bold">${stats.notVisited}</td></tr>
                <tr class="bg-gray-100 font-bold"><td class="p-2">Total</td><td class="p-2 text-center">${currentQuestions.length}</td></tr>
            `;
            document.getElementById('submitModal').classList.remove('hidden-all');
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').classList.add('hidden-all');
        }

        function finalSubmit() {
            clearInterval(timerInterval);
            closeSubmitModal();
            showResults();
        }

        // ==================== RESULTS ====================
        function showResults() {
            document.getElementById('examSection').classList.add('hidden-all');
            document.getElementById('resultSection').classList.remove('hidden-all');

            let correct = 0, wrong = 0, unattempted = 0;
            const wrongQuestions = [];
            const correctQuestions = [];
            const skippedQuestions = [];
            const lang = document.getElementById('languageSelect').value;

            currentQuestions.forEach((q, i) => {
                const userAns = userAnswers[i];
                const availableOptions = getAvailableOptions(q, lang);
                const correctNum = getCorrectAnswerIndex(q, availableOptions);
                const qType = getQuestionType(q);
                const explanation = q.Explanation || 'कोई व्याख्या नहीं।';
                
                const result = {
                    index: i + 1,
                    question: (q.Question || '').replace(/\[IMAGE:.*?\]/g, ''),
                    userAnswer: userAns,
                    correctAnswer: correctNum,
                    correctLetter: availableOptions.find(opt => opt.index.toString() === correctNum)?.key || correctNum,
                    correctText: availableOptions.find(opt => opt.index.toString() === correctNum)?.text || correctNum,
                    explanation: explanation,
                    availableOptions: availableOptions,
                    questionType: qType,
                    listData: qType === 'list-matching' ? getListData(q) : null
                };

                if (!userAns) {
                    unattempted++;
                    skippedQuestions.push(result);
                } else if (userAns === correctNum) {
                    correct++;
                    correctQuestions.push(result);
                } else {
                    wrong++;
                    wrongQuestions.push(result);
                }
            });

            const score = correct - (wrong * 0.25);
            document.getElementById('resTotal').textContent = currentQuestions.length;
            document.getElementById('resCorrect').textContent = correct;
            document.getElementById('resWrong').textContent = wrong;
            document.getElementById('resUnattempted').textContent = unattempted;
            document.getElementById('resScore').textContent = score.toFixed(2);

            renderResultList('wrongQuestionsList', wrongQuestions, 'wrong');
            renderResultList('correctQuestionsList', correctQuestions, 'correct');
            renderResultList('skippedQuestionsList', skippedQuestions, 'skipped');
        }

        function renderResultList(containerId, questions, type) {
            const container = document.getElementById(containerId);
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No questions in this category.</p>';
                return;
            }

            container.innerHTML = questions.map(q => {
                let userOpt = '-', userText = 'Not attempted';
                if (q.userAnswer) {
                    const userOption = q.availableOptions.find(opt => opt.index.toString() === q.userAnswer);
                    if (userOption) { userOpt = userOption.key; userText = userOption.text; }
                }

                let statusHtml = '';
                if (type === 'wrong') statusHtml = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">गलत</span>`;
                else if (type === 'correct') statusHtml = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">सही</span>`;
                else statusHtml = `<span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold">प्रयास नहीं</span>`;

                let questionDisplay = q.question;
                if (q.questionType === 'list-matching' && q.listData && (q.listData.list1.length > 0 || q.listData.list2.length > 0)) {
                    questionDisplay += `
                        <div class="mt-3 grid md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded border">
                            <div><strong class="text-blue-700">सूची-I:</strong><br>${q.listData.list1.map(i => `<span class="text-gray-700">${i.key}. ${i.text}</span>`).join('<br>') || 'No data'}</div>
                            <div><strong class="text-blue-700">सूची-II:</strong><br>${q.listData.list2.map(i => `<span class="text-gray-700">${i.key}. ${i.text}</span>`).join('<br>') || 'No data'}</div>
                        </div>`;
                }

                return `
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 ${type === 'wrong' ? 'border-red-500' : type === 'correct' ? 'border-green-500' : 'border-gray-400'}">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-gray-800">प्रश्न ${q.index}</h4>
                            ${statusHtml}
                        </div>
                        <div class="text-gray-700 mb-3">${questionDisplay}</div>
                        <div class="grid md:grid-cols-2 gap-2 mb-3 text-sm">
                            <div class="bg-green-50 p-2 rounded border border-green-200">
                                <span class="font-semibold text-green-700">सही उत्तर: ${q.correctLetter}</span>
                                <p class="text-gray-600">${q.correctText}</p>
                            </div>
                            ${type === 'wrong' ? `
                            <div class="bg-red-50 p-2 rounded border border-red-200">
                                <span class="font-semibold text-red-700">आपका उत्तर: ${userOpt}</span>
                                <p class="text-gray-600">${userText}</p>
                            </div>` : ''}
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="font-semibold text-blue-700 mb-1"><i class="fas fa-lightbulb mr-2"></i>व्याख्या:</p>
                            <p class="text-gray-700 text-sm">${q.explanation}</p>
                        </div>
                    </div>`;
            }).join('');
        }

        function restartTest() {
            userAnswers = new Array(currentQuestions.length).fill(null);
            questionStatus = new Array(currentQuestions.length).fill('not-visited');
            currentIndex = 0; selectedOption = null;
            document.getElementById('resultSection').classList.add('hidden-all');
            document.getElementById('examSection').classList.remove('hidden-all');
            timeRemaining = currentQuestions.length * 60;
            startTimer(); renderQuestion(); renderPalette(); updateStats();
        }

        function newTest() { location.reload(); }
    </script>
</body>
</html>
