<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>घटना चक्र पोर्टल - Ghatna Chakra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Segoe UI',Arial,sans-serif}
        .hidden-all{display:none!important}
        .password-container{background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .password-card{background:white;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);width:100%;max-width:420px;overflow:hidden}
        .password-header{background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);padding:30px;text-align:center}
        .gc-logo{width:80px;height:80px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px}
        .gc-logo-inner{width:65px;height:65px;border-radius:50%;background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold}
        .password-body{padding:35px 30px}
        .password-input{width:100%;padding:15px 15px 15px 50px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px}
        .password-input:focus{border-color:#dc2626;outline:none;box-shadow:0 0 0 4px rgba(220,38,38,0.1)}
        .password-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:#dc2626;font-size:18px}
        .password-input-wrapper{position:relative;margin-bottom:20px}
        .unlock-btn{width:100%;padding:15px;background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer}
        .error-message{background:#fee2e2;color:#dc2626;padding:12px;border-radius:8px;margin-top:15px;display:none;align-items:center;gap:8px}
        .error-message.show{display:flex}
        .palette-btn{width:40px;height:40px;border:2px solid #ddd;background:white;color:#333;font-weight:bold;cursor:pointer}
        .palette-not-visited{background:#f8f9fa;border-color:#adb5bd;color:#6c757d}
        .palette-not-answered{background:#dc2626;border-color:#dc2626;color:white}
        .palette-answered{background:#059669;border-color:#059669;color:white}
        .palette-marked{background:#7c3aed;border-color:#7c3aed;color:white}
        .palette-current{box-shadow:0 0 0 3px #dc2626;transform:scale(1.15)}
        .option-label{display:flex;align-items:center;padding:12px 16px;border:2px solid #dee2e6;border-radius:8px;margin-bottom:10px;cursor:pointer}
        .option-label:hover{background:#fef2f2;border-color:#fca5a5}
        .option-label.selected{background:#fef2f2;border-color:#dc2626}
        .option-circle{width:32px;height:32px;border-radius:50%;background:#f8f9fa;border:2px solid #adb5bd;display:flex;align-items:center;justify-content:center;margin-right:12px;font-weight:bold}
        .option-label.selected .option-circle{background:#dc2626;border-color:#dc2626;color:white}
        .timer-box{background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);color:white;padding:8px 16px;border-radius:8px;font-family:'Courier New',monospace;font-weight:bold;font-size:1.1rem}
        .btn-gc{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer}
        .btn-save-next{background:#059669;color:white}
        .btn-save-review{background:#ffc107;color:#212529}
        .btn-clear{background:#6c757d;color:white}
        .btn-mark-review{background:#7c3aed;color:white}
        .btn-submit{background:#dc2626;color:white}
        .btn-proceed{background:#dc2626;color:white;padding:12px 40px;font-size:1.1rem}
        .upload-area{border:2px dashed #dc2626;border-radius:10px;padding:40px;text-align:center;background:#fef2f2;cursor:pointer}
        .loading-spinner{width:60px;height:60px;border:4px solid #f3f3f3;border-top:4px solid #dc2626;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- PASSWORD -->
    <div id="passwordOverlay" class="password-container">
        <div class="password-card">
            <div class="password-header">
                <div class="gc-logo"><div class="gc-logo-inner">GC</div></div>
                <h1 class="text-white text-xl font-bold">घटना चक्र पोर्टल</h1>
                <p class="text-red-200 text-sm mt-1">Current Affairs & GS</p>
            </div>
            <div class="password-body">
                <h2 class="text-center text-gray-800 text-lg font-semibold mb-2">सुरक्षित लॉगिन</h2>
                <div class="password-input-wrapper">
                    <i class="fas fa-lock password-icon"></i>
                    <input type="password" id="sitePass" class="password-input" placeholder="पासवर्ड दर्ज करें">
                </div>
                <button onclick="checkPass()" class="unlock-btn"><i class="fas fa-unlock-alt mr-2"></i>पोर्टल खोलें</button>
                <div id="passError" class="error-message"><i class="fas fa-exclamation-triangle"></i>गलत पासवर्ड!</div>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loadingSection" class="hidden-all min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-100">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold text-gray-700">प्रश्न लोड हो रहे हैं...</p>
        </div>
    </div>

    <!-- CSV UPLOAD -->
    <div id="uploadSection" class="hidden-all min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-red-50 to-orange-100">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-red-600 text-white p-4 text-center">
                <h2 class="text-xl font-bold"><i class="fas fa-upload mr-2"></i>CSV डेटा अपलोड करें</h2>
            </div>
            <div class="p-6">
                <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                    <i class="fas fa-cloud-upload-alt text-5xl text-red-600 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">CSV फाइल अपलोड करें</h3>
                    <p class="text-gray-500 text-sm">या यहां क्लिक करें</p>
                    <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleCSVUpload(event)">
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-2"><strong>CSV फॉर्मेट:</strong></p>
                    <code class="block bg-gray-100 p-3 rounded text-xs">
                        Subject,Sub-Subject,Question,Option A,Option B,Option C,Option D,Answer,Explanation<br>
                        Current Affairs,Jan 2025,भारत का पहला सौर मिशन?,आदित्य-L1,चंद्रयान-1,मंगलयान,Gaganyaan,A,आदित्य-L1 भारत का पहला सौर मिशन है।
                    </code>
                </div>
                <button onclick="useDefaultData()" class="w-full mt-4 btn-gc bg-gray-600 text-white py-3 rounded">
                    <i class="fas fa-database mr-2"></i>डिफॉल्ट डेटा का उपयोग करें
                </button>
            </div>
        </div>
    </div>

    <!-- SUBJECT SELECTION -->
    <div id="subjectSection" class="hidden-all min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-red-50 to-orange-100">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-orange-500 text-white p-4 text-center">
                <h2 class="text-xl font-bold"><i class="fas fa-book mr-2"></i>विषय चुनें</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">मुख्य विषय</label>
                    <select id="mainSubject" onchange="updateSubSubjects()" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                        <option value="">-- विषय चुनें --</option>
                    </select>
                </div>
                <div id="subSubjectContainer" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2">उप-विषय</label>
                    <select id="subSubject" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                        <option value="">-- सभी टॉपिक --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">प्रश्नों की संख्या</label>
                    <select id="questionCount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                        <option value="10">10 प्रश्न</option>
                        <option value="25">25 प्रश्न</option>
                        <option value="50">50 प्रश्न</option>
                        <option value="100">100 प्रश्न</option>
                        <option value="all">सभी उपलब्ध</option>
                    </select>
                </div>
                <button onclick="startExam()" class="w-full btn-gc btn-proceed mt-4"><i class="fas fa-play mr-2"></i>परीक्षा शुरू करें</button>
            </div>
        </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div id="instructionSection" class="hidden-all">
        <div class="bg-red-600 text-white p-4">
            <div class="max-w-7xl mx-auto flex items-center gap-3">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-red-600 font-bold text-xl">GC</div>
                <div>
                    <h1 class="text-xl font-bold">घटना चक्र पोर्टल</h1>
                    <p class="text-xs text-red-200">Current Affairs & GS Special</p>
                </div>
            </div>
        </div>
        <div class="bg-orange-500 text-white p-3"><div class="max-w-7xl mx-auto"><h2 class="text-lg font-bold">सामान्य निर्देश</h2></div></div>
        <div class="max-w-5xl mx-auto p-6">
            <h3 class="text-xl font-bold text-center mb-6">कृपया निर्देश ध्यान से पढ़ें</h3>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h4 class="font-bold text-lg mb-4">महत्वपूर्ण निर्देश:</h4>
                <ol class="list-decimal list-inside space-y-3 text-gray-700">
                    <li>परीक्षा की कुल अवधि टाइमर पर प्रदर्शित होगी।</li>
                    <li>जब टाइमर शून्य होगा तो परीक्षा स्वतः समाप्त हो जाएगी।</li>
                    <li>प्रश्न पैलेट में प्रत्येक प्रश्न की स्थिति दर्शाई जाएगी।</li>
                </ol>
                <div class="mt-6 text-gray-700">
                    <p class="mb-2 font-bold">मार्किंग स्कीम:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="text-green-600 font-bold">+1 अंक</span> प्रत्येक सही उत्तर के लिए</li>
                        <li><span class="text-red-600 font-bold">-0.25 अंक</span> प्रत्येक गलत उत्तर के लिए</li>
                        <li><span class="text-gray-600 font-bold">0 अंक</span> अनुत्तरित प्रश्नों के लिए</li>
                    </ul>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="declaration" class="mt-1 w-5 h-5">
                    <span class="text-gray-700">मैंने निर्देश पढ़ लिए हैं और परीक्षा देने के लिए तैयार हूं।</span>
                </label>
            </div>
            <div class="text-center">
                <button onclick="proceedToExam()" class="btn-gc btn-proceed"><i class="fas fa-arrow-right mr-2"></i>आगे बढ़ें</button>
            </div>
        </div>
    </div>

    <!-- EXAM -->
    <div id="examSection" class="hidden-all">
        <div class="bg-red-600 text-white p-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-red-600 font-bold">GC</div>
                    <div>
                        <h1 class="text-lg font-bold">घटना चक्र पोर्टल</h1>
                        <p class="text-xs text-red-200">Current Affairs & GS</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-red-200">विषय</p>
                        <p class="font-semibold" id="examSubject">टेस्ट</p>
                    </div>
                    <div class="timer-box"><i class="fas fa-clock mr-2"></i><span id="timer">00:00:00</span></div>
                </div>
            </div>
        </div>
        <div class="bg-orange-500 text-white p-2">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <h2 class="font-bold" id="examTitle">घटना चक्र मॉक टेस्ट</h2>
            </div>
        </div>
        <div class="max-w-7xl mx-auto p-4">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1 bg-white rounded-lg shadow p-6">
                    <div id="questionContainer">
                        <h3 class="text-lg font-bold mb-4">प्रश्न <span id="qNumber">1</span>:</h3>
                        <div id="questionText" class="text-gray-800 mb-6 text-lg leading-relaxed"></div>
                        <div id="optionsContainer" class="space-y-3"></div>
                    </div>
                    <div class="mt-8 flex flex-wrap gap-3">
                        <button onclick="saveAndNext()" class="btn-gc btn-save-next"><i class="fas fa-save mr-1"></i>सेव और आगे</button>
                        <button onclick="saveAndMarkReview()" class="btn-gc btn-save-review"><i class="fas fa-bookmark mr-1"></i>सेव और रिव्यू</button>
                        <button onclick="clearResponse()" class="btn-gc btn-clear"><i class="fas fa-eraser mr-1"></i>क्लियर</button>
                        <button onclick="markReviewAndNext()" class="btn-gc btn-mark-review"><i class="fas fa-flag mr-1"></i>रिव्यू और आगे</button>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="prevQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100"><< पीछे</button>
                        <button onclick="nextQuestion()" class="px-4 py-2 border-2 border-gray-300 rounded hover:bg-gray-100">आगे >></button>
                    </div>
                </div>
                <div class="lg:w-80 bg-white rounded-lg shadow p-4">
                    <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">प्रश्न पैलेट</h4>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-gray-400 flex items-center justify-center text-white font-bold" id="statNotVisited">0</span><span>नहीं देखा</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-red-500 flex items-center justify-center text-white font-bold" id="statNotAnswered">0</span><span>उत्तर नहीं</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-green-500 flex items-center justify-center text-white font-bold" id="statAnswered">0</span><span>उत्तर दिया</span></div>
                        <div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-purple-600 flex items-center justify-center text-white font-bold" id="statMarked">0</span><span>रिव्यू</span></div>
                    </div>
                    <div id="questionPalette" class="grid grid-cols-5 gap-2 max-h-80 overflow-y-auto p-2"></div>
                    <button onclick="confirmSubmit()" class="w-full mt-4 btn-gc btn-submit py-3"><i class="fas fa-check-circle mr-2"></i>सबमिट करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBMIT MODAL -->
    <div id="submitModal" class="hidden-all fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-center mb-4">परीक्षा सारांश</h3>
            <table class="w-full mb-6 text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">स्थिति</th><th class="p-2 text-center">संख्या</th></tr></thead><tbody id="summaryTable"></tbody></table>
            <p class="text-center text-gray-700 mb-4 font-semibold">क्या आप वाकई सबमिट करना चाहते हैं?</p>
            <div class="flex justify-center gap-4">
                <button onclick="finalSubmit()" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 font-semibold">हां</button>
                <button onclick="closeSubmitModal()" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-semibold">नहीं</button>
            </div>
        </div>
    </div>

    <!-- RESULT -->
    <div id="resultSection" class="hidden-all">
        <div class="bg-red-600 text-white p-4 text-center">
            <h1 class="text-2xl font-bold">घटना चक्र पोर्टल</h1>
            <p class="text-red-200">Current Affairs & GS Special</p>
        </div>
        <div class="max-w-5xl mx-auto p-6">
            <h2 class="text-2xl font-bold text-center mb-6">परिणाम</h2>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg"><p class="text-gray-600 text-sm">कुल प्रश्न</p><p class="text-2xl font-bold text-blue-600" id="resTotal">0</p></div>
                    <div class="text-center p-4 bg-green-50 rounded-lg"><p class="text-gray-600 text-sm">सही</p><p class="text-2xl font-bold text-green-600" id="resCorrect">0</p></div>
                    <div class="text-center p-4 bg-red-50 rounded-lg"><p class="text-gray-600 text-sm">गलत</p><p class="text-2xl font-bold text-red-600" id="resWrong">0</p></div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg"><p class="text-gray-600 text-sm">अनुत्तरित</p><p class="text-2xl font-bold text-yellow-600" id="resUnattempted">0</p></div>
                </div>
                <div class="text-center p-6 bg-gradient-to-r from-red-600 to-red-800 rounded-lg text-white">
                    <p class="text-lg mb-2">अंतिम स्कोर</p>
                    <p class="text-5xl font-bold" id="resScore">0.00</p>
                    <p class="text-sm mt-2 opacity-80">(+1 सही, -0.25 गलत)</p>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="restartTest()" class="btn-gc btn-proceed mr-3"><i class="fas fa-redo mr-2"></i>फिर से दें</button>
                    <button onclick="newTest()" class="btn-gc bg-gray-600 text-white px-6 py-3 rounded"><i class="fas fa-home mr-2"></i>नया टेस्ट</button>
                </div>
            </div>
            <h3 class="text-xl font-bold mb-4 text-red-600"><i class="fas fa-times-circle mr-2"></i>गलत उत्तर</h3>
            <div id="wrongQuestionsList" class="space-y-4 mb-8"></div>
            <h3 class="text-xl font-bold mb-4 text-green-600"><i class="fas fa-check-circle mr-2"></i>सही उत्तर</h3>
            <div id="correctQuestionsList" class="space-y-4 mb-8"></div>
            <h3 class="text-xl font-bold mb-4 text-gray-600"><i class="fas fa-minus-circle mr-2"></i>अनुत्तरित</h3>
            <div id="skippedQuestionsList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const CONFIG = { PASSWORD: 'ghatna2024' };
        let allQuestions = [], currentQuestions = [], userAnswers = [], questionStatus = [], currentIndex = 0, timerInterval, timeRemaining = 0, selectedOption = null;

        // PASSWORD
        function checkPass() {
            if (document.getElementById('sitePass').value === CONFIG.PASSWORD) {
                document.getElementById('passwordOverlay').classList.add('hidden-all');
                document.getElementById('uploadSection').classList.remove('hidden-all');
            } else {
                document.getElementById('passError').classList.add('show');
            }
        }
        document.getElementById('sitePass')?.addEventListener('keypress', e => { if (e.key === 'Enter') checkPass(); });

        // CSV UPLOAD
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('uploadSection').classList.add('hidden-all');
            document.getElementById('loadingSection').classList.remove('hidden-all');
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allQuestions = results.data.filter(q => q.Question && q.Question.trim() !== '');
                        populateSubjects();
                        document.getElementById('loadingSection').classList.add('hidden-all');
                        document.getElementById('subjectSection').classList.remove('hidden-all');
                    }
                }
            });
        }

        // DEFAULT DATA
        function useDefaultData() {
            const sampleCSV = `Subject,Sub-Subject,Question,Option A,Option B,Option C,Option D,Answer,Explanation
Current Affairs,January 2025,भारत का पहला सौर मिशन कौन सा है?,आदित्य-L1,चंद्रयान-1,मंगलयान,Gaganyaan,A,आदित्य-L1 भारत का पहला सौर मिशन है।
Current Affairs,January 2025,2024 का नोबेल शांति पुरस्कार किसे मिला?,मोहम्मद यूनुस,जसिंदा अर्डर्न,वोलोडिमिर जेलेंस्की,रिशी सुनक,A,मोहम्मद यूनुस को 2024 का नोबेल शांति पुरस्कार मिला।
History,Ancient,मोहेनजोदड़ो किस नदी के किनारे स्थित है?,गंगा,सिंधु,यमुना,सरस्वती,B,मोहेनजोदड़ो सिंधु नदी के किनारे स्थित था।
Polity,Constitution,भारतीय संविधान में कितनी अनुसूचियां हैं?,8,10,12,14,C,भारतीय संविधान में 12 अनुसूचियां हैं।`;
            
            document.getElementById('uploadSection').classList.add('hidden-all');
            document.getElementById('loadingSection').classList.remove('hidden-all');
            Papa.parse(sampleCSV, {
                header: true,
                complete: function(results) {
                    allQuestions = results.data;
                    populateSubjects();
                    document.getElementById('loadingSection').classList.add('hidden-all');
                    document.getElementById('subjectSection').classList.remove('hidden-all');
                }
            });
        }

        function populateSubjects() {
            const subjects = [...new Set(allQuestions.map(q => q.Subject))].filter(s => s).sort();
            const select = document.getElementById('mainSubject');
            select.innerHTML = '<option value="">-- विषय चुनें --</option>';
            subjects.forEach(s => select.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function updateSubSubjects() {
            const subject = document.getElementById('mainSubject').value;
            const container = document.getElementById('subSubjectContainer');
            const subSelect = document.getElementById('subSubject');
            if (!subject) { container.classList.add('hidden'); return; }
            const subSubjects = [...new Set(allQuestions.filter(q => q.Subject === subject).map(q => q['Sub-Subject']).filter(s => s))].sort();
            if (subSubjects.length > 0) {
                container.classList.remove('hidden');
                subSelect.innerHTML = '<option value="">-- सभी टॉपिक --</option>';
                subSubjects.forEach(s => subSelect.innerHTML += `<option value="${s}">${s}</option>`);
            } else {
                container.classList.add('hidden');
            }
        }

        function startExam() {
            const subject = document.getElementById('mainSubject').value;
            const subSubject = document.getElementById('subSubject').value;
            const count = document.getElementById('questionCount').value;
            if (!subject) { alert('कृपया विषय चुनें!'); return; }
            currentQuestions = allQuestions.filter(q => {
                if (q.Subject !== subject) return false;
                if (subSubject && q['Sub-Subject'] !== subSubject) return false;
                return true;
            });
            if (currentQuestions.length === 0) { alert('कोई प्रश्न नहीं मिले!'); return; }
            currentQuestions = shuffleArray([...currentQuestions]);
            if (count !== 'all' && currentQuestions.length > parseInt(count)) {
                currentQuestions = currentQuestions.slice(0, parseInt(count));
            }
            userAnswers = new Array(currentQuestions.length).fill(null);
            questionStatus = new Array(currentQuestions.length).fill('not-visited');
            currentIndex = 0;
            document.getElementById('examSubject').textContent = subject;
            document.getElementById('subjectSection').classList.add('hidden-all');
            document.getElementById('instructionSection').classList.remove('hidden-all');
        }

        function proceedToExam() {
            if (!document.getElementById('declaration').checked) { alert('कृपया घोषणा स्वीकार करें!'); return; }
            document.getElementById('instructionSection').classList.add('hidden-all');
            document.getElementById('examSection').classList.remove('hidden-all');
            timeRemaining = currentQuestions.length * 60;
            startTimer();
            renderQuestion();
            renderPalette();
            updateStats();
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) { clearInterval(timerInterval); alert('समय समाप्त!'); finalSubmit(); }
            }, 1000);
        }

        function updateTimerDisplay() {
            const h = Math.floor(timeRemaining / 3600);
            const m = Math.floor((timeRemaining % 3600) / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer').textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function renderQuestion() {
            const q = currentQuestions[currentIndex];
            document.getElementById('qNumber').textContent = currentIndex + 1;
            document.getElementById('questionText').textContent = q.Question;
            if (questionStatus[currentIndex] === 'not-visited') questionStatus[currentIndex] = 'not-answered';
            const optionsDiv = document.getElementById('optionsContainer');
            optionsDiv.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach((opt, idx) => {
                const optText = q['Option ' + opt] || q['Option' + opt];
                if (!optText) return;
                const label = document.createElement('label');
                label.className = 'option-label';
                if (userAnswers[currentIndex] === (idx + 1).toString()) label.classList.add('selected');
                label.onclick = () => selectOption((idx + 1).toString());
                label.innerHTML = `<div class="option-circle">${opt}</div><div class="flex-1">${optText}</div><input type="radio" name="option" value="${idx + 1}" class="hidden" ${userAnswers[currentIndex] === (idx + 1).toString() ? 'checked' : ''}>`;
                optionsDiv.appendChild(label);
            });
            selectedOption = userAnswers[currentIndex];
            renderPalette();
            updateStats();
        }

        function selectOption(value) {
            selectedOption = value;
            userAnswers[currentIndex] = value;
            questionStatus[currentIndex] = 'answered';
            renderQuestion();
        }

        function renderPalette() {
            const palette = document.getElementById('questionPalette');
            palette.innerHTML = '';
            for (let i = 0; i < currentQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.textContent = i + 1;
                let statusClass = 'palette-not-visited';
                if (questionStatus[i] === 'not-answered') statusClass = 'palette-not-answered';
                else if (questionStatus[i] === 'answered') statusClass = 'palette-answered';
                else if (questionStatus[i] === 'marked') statusClass = 'palette-marked';
                btn.classList.add(statusClass);
                if (i === currentIndex) btn.classList.add('palette-current');
                btn.onclick = () => { currentIndex = i; renderQuestion(); };
                palette.appendChild(btn);
            }
        }

        function updateStats() {
            document.getElementById('statNotVisited').textContent = questionStatus.filter(s => s === 'not-visited').length;
            document.getElementById('statNotAnswered').textContent = questionStatus.filter(s => s === 'not-answered').length;
            document.getElementById('statAnswered').textContent = questionStatus.filter(s => s === 'answered').length;
            document.getElementById('statMarked').textContent = questionStatus.filter(s => s === 'marked').length;
        }

        function saveAndNext() {
            if (selectedOption) { userAnswers[currentIndex] = selectedOption; questionStatus[currentIndex] = 'answered'; }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function saveAndMarkReview() {
            if (selectedOption) { userAnswers[currentIndex] = selectedOption; questionStatus[currentIndex] = 'answered-marked'; }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function clearResponse() { selectedOption = null; userAnswers[currentIndex] = null; questionStatus[currentIndex] = 'not-answered'; renderQuestion(); }

        function markReviewAndNext() {
            if (selectedOption) { userAnswers[currentIndex] = selectedOption; questionStatus[currentIndex] = 'answered-marked'; }
            else { questionStatus[currentIndex] = 'marked'; }
            if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); }
        }

        function nextQuestion() { if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); } }
        function prevQuestion() { if (currentIndex > 0) { currentIndex--; renderQuestion(); } }

        function confirmSubmit() {
            const stats = { answered: questionStatus.filter(s => s === 'answered' || s === 'answered-marked').length, notAnswered: questionStatus.filter(s => s === 'not-answered').length, marked: questionStatus.filter(s => s === 'marked').length, notVisited: questionStatus.filter(s => s === 'not-visited').length };
            document.getElementById('summaryTable').innerHTML = `<tr><td class="p-2 border">उत्तर दिए</td><td class="p-2 border text-center">${stats.answered}</td></tr><tr><td class="p-2 border">उत्तर नहीं दिए</td><td class="p-2 border text-center">${stats.notAnswered}</td></tr><tr><td class="p-2 border">रिव्यू के लिए</td><td class="p-2 border text-center">${stats.marked}</td></tr><tr class="bg-gray-100 font-bold"><td class="p-2 border">कुल</td><td class="p-2 border text-center">${currentQuestions.length}</td></tr>`;
            document.getElementById('submitModal').classList.remove('hidden-all');
        }

        function closeSubmitModal() { document.getElementById('submitModal').classList.add('hidden-all'); }

        function finalSubmit() {
            clearInterval(timerInterval);
            closeSubmitModal();
            showResults();
        }

        function showResults() {
            document.getElementById('examSection').classList.add('hidden-all');
            document.getElementById('resultSection').classList.remove('hidden-all');
            let correct = 0, wrong = 0, unattempted = 0;
            const wrongQuestions = [], correctQuestions = [], skippedQuestions = [];
            currentQuestions.forEach((q, i) => {
                const userAns = userAnswers[i];
                const correctAns = (q.Answer || '').toString().trim().toUpperCase();
                let correctNum = '';
                if (correctAns === 'A' || correctAns === '1') correctNum = '1';
                else if (correctAns === 'B' || correctAns === '2') correctNum = '2';
                else if (correctAns === 'C' || correctAns === '3') correctNum = '3';
                else if (correctAns === 'D' || correctAns === '4') correctNum = '4';
                const result = { index: i + 1, question: q.Question, userAnswer: userAns, correctAnswer: correctNum, correctText: q['Option ' + correctAns] || q['Option' + correctAns], explanation: q.Explanation || 'कोई व्याख्या नहीं।', options: { A: q['Option A'] || q['OptionA'], B: q['Option B'] || q['OptionB'], C: q['Option C'] || q['OptionC'], D: q['Option D'] || q['OptionD'] } };
                if (!userAns) { unattempted++; skippedQuestions.push(result); }
                else if (userAns === correctNum) { correct++; correctQuestions.push(result); }
                else { wrong++; wrongQuestions.push(result); }
            });
            const score = correct - (wrong * 0.25);
            document.getElementById('resTotal').textContent = currentQuestions.length;
            document.getElementById('resCorrect').textContent = correct;
            document.getElementById('resWrong').textContent = wrong;
            document.getElementById('resUnattempted').textContent = unattempted;
            document.getElementById('resScore').textContent = score.toFixed(2);
            renderList('wrongQuestionsList', wrongQuestions, 'wrong');
            renderList('correctQuestionsList', correctQuestions, 'correct');
            renderList('skippedQuestionsList', skippedQuestions, 'skipped');
        }

        function renderList(containerId, questions, type) {
            const container = document.getElementById(containerId);
            if (questions.length === 0) { container.innerHTML = '<p class="text-gray-500 italic">कोई प्रश्न नहीं।</p>'; return; }
            container.innerHTML = questions.map(q => {
                const userOpt = q.userAnswer ? ['A', 'B', 'C', 'D'][q.userAnswer - 1] : '-';
                const correctOpt = ['A', 'B', 'C', 'D'][q.correctAnswer - 1];
                let statusHtml = '';
                if (type === 'wrong') statusHtml = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">गलत</span>`;
                else if (type === 'correct') statusHtml = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">सही</span>`;
                else statusHtml = `<span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-bold">अनुत्तरित</span>`;
                return `<div class="bg-white rounded-lg shadow p-4"><div class="flex items-center justify-between mb-3"><h4 class="font-bold text-gray-800">प्रश्न ${q.index}</h4>${statusHtml}</div><p class="text-gray-700 mb-3">${q.question}</p><div class="grid md:grid-cols-2 gap-2 mb-3 text-sm"><div class="bg-green-50 p-2 rounded border border-green-200"><span class="font-semibold text-green-700">सही उत्तर: ${correctOpt}</span><p class="text-gray-600">${q.options[correctOpt] || ''}</p></div>${type === 'wrong' ? `<div class="bg-red-50 p-2 rounded border border-red-200"><span class="font-semibold text-red-700">आपका उत्तर: ${userOpt}</span><p class="text-gray-600">${q.options[userOpt] || 'प्रयास नहीं किया'}</p></div>` : ''}</div><div class="bg-blue-50 p-3 rounded-lg"><p class="font-semibold text-blue-700 mb-1"><i class="fas fa-lightbulb mr-2"></i>व्याख्या:</p><p class="text-gray-700 text-sm">${q.explanation}</p></div></div>`;
            }).join('');
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function restartTest() { userAnswers = new Array(currentQuestions.length).fill(null); questionStatus = new Array(currentQuestions.length).fill('not-visited'); currentIndex = 0; selectedOption = null; currentQuestions = shuffleArray([...currentQuestions]); document.getElementById('resultSection').classList.add('hidden-all'); document.getElementById('examSection').classList.remove('hidden-all'); timeRemaining = currentQuestions.length * 60; startTimer(); renderQuestion(); renderPalette(); updateStats(); }
        function newTest() { location.reload(); }
    </script>
</body>
</html>
